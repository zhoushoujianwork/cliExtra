# cliExtra Agent 状态监控设计方案

## 核心思路

### 基本原理
监控每个agent的tmux.log文件的最后修改时间，通过文件时间戳变化判断agent是否处于活跃状态。如果文件在指定时间内（如5秒）没有更新，则认为agent处于空闲状态。

### 设计优势
- **极简实现**: 只需检查文件修改时间戳
- **零误判**: 基于实际输出变化，不受内容格式影响
- **高性能**: stat系统调用比文本解析效率高
- **自适应**: 自动适应所有AI agent的输出格式
- **免维护**: 无需针对新的输出格式更新规则

## 架构设计

### 监控流程
1. **文件定位**: 根据instance_id和namespace确定tmux.log文件路径
2. **时间戳获取**: 使用stat命令获取文件最后修改时间
3. **空闲计算**: 当前时间 - 文件修改时间 = 空闲时长
4. **状态判断**: 空闲时长 >= 阈值 → 空闲，否则 → 忙碌
5. **状态更新**: 更新agent状态文件

### 配置策略
- **默认阈值**: 5秒（快速响应场景）
- **场景定制**: 
  - 交互式对话: 5秒
  - 批处理任务: 30秒  
  - 开发调试: 10秒
- **Namespace级别**: 支持按namespace设置不同阈值

### 文件路径规则
```
$CLIEXTRA_NAMESPACES_DIR/{namespace}/logs/instance_{instance_id}_tmux.log
```

## 实施要点

### 跨平台兼容
- **macOS**: 使用 `stat -f %m` 获取时间戳
- **Linux**: 使用 `stat -c %Y` 获取时间戳
- **错误处理**: 文件不存在或权限不足时的优雅降级

### 性能优化
- **检查频率**: 从当前2秒调整为3秒间隔
- **批量处理**: 同时检查多个agent的状态
- **缓存机制**: 避免重复的文件系统调用

### 容错设计
- **文件缺失**: 返回"状态未知"，保持当前状态
- **权限问题**: 记录警告日志，尝试其他检测方法
- **网络文件系统**: 检测并处理时间戳延迟

## 配置体系

### 全局配置
```
IDLE_THRESHOLD_SECONDS=5
STATUS_CHECK_INTERVAL=3
FILE_STAT_TIMEOUT=1
```

### 场景配置
```
THRESHOLD_INTERACTIVE=5    # 交互场景
THRESHOLD_BATCH=30         # 批处理场景  
THRESHOLD_DEVELOPMENT=10   # 开发场景
```

### 动态配置
- 支持运行时调整阈值
- 支持按namespace覆盖全局设置
- 支持临时调整某个agent的阈值

## 监控增强

### 状态分类
- **Active**: 文件在阈值时间内有更新
- **Idle**: 文件超过阈值时间未更新
- **Unknown**: 无法确定状态（文件问题等）
- **Offline**: tmux会话不存在

### 调试支持
- 详细的时间戳日志记录
- 状态变化历史追踪
- 文件系统性能监控
- 阈值调优建议

### 指标收集
- 平均空闲检测时间
- 状态切换频率统计
- 文件系统访问延迟
- 检测准确率评估

## 集成方案

### 现有系统集成
- 保持现有状态管理API不变
- 替换底层检测算法
- 兼容现有的DAG工作流监控
- 保持status文件格式不变

### 渐进式部署
- 支持新旧方案并行运行
- 提供切换开关配置
- 逐步迁移各namespace
- 完全切换后清理旧代码

### 向后兼容
- 现有脚本无需修改
- 保持所有命令行接口
- 维护相同的日志格式
- 确保状态文件格式一致

## 质量保证

### 测试策略
- 单agent长时间运行测试
- 多agent并发状态检测测试
- 各种交互模式验证测试
- 边界条件和异常情况测试

### 性能验证
- 监控CPU和内存使用率
- 测量检测延迟和准确性
- 压力测试多agent场景
- 长期稳定性验证

### 安全考虑
- 文件访问权限控制
- 避免路径遍历攻击
- 输入参数验证
- 日志敏感信息过滤 